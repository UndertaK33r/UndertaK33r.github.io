<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <title>
    
    Go八股之并发编程（1） - 
    Undertaker&#39;s Blog
  </title>
  <meta property="og:title" content="Go八股之并发编程（1） - Undertaker&#39;s Blog" />
  <meta property="og:site_name" content="Undertaker&#39;s Blog" />

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  

  <meta property="og:type" content="article" />


  
  <link rel="shortcut icon" href="/mylogo.ico" />
  

  

  
  <link rel="canonical" href="https://undertak33r.github.io/2025/09/24/Go%E5%85%AB%E8%82%A1%E4%B9%8B%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%881%EF%BC%89/">
  <meta name="og:url" content="https://undertak33r.github.io/2025/09/24/Go%E5%85%AB%E8%82%A1%E4%B9%8B%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%881%EF%BC%89/">
  
  <!-- 现代化字体加载 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <!-- particles.js 库 -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  
  
<link rel="stylesheet" href="/css/style.css">


<meta name="generator" content="Hexo 8.0.0"></head>

<body>
  

  <div class="title">
  <img class="title_img" alt="Title image" width="300" height="300" src="/images/mylogo.jpg" /><br>
  <div id="site_title">Undertaker's Blog</div>
</div>
  <div class="navi">
  <a id="navi_item_title" href="/#" class="menu-item-link">
    [主页]
  </a>
  <a id="navi_item_tags" href="/tags" class="menu-item-link">
    [标签]
  </a>
  <a id="navi_item_about" href="/about" class="menu-item-link">
    [关于]
  </a>
  <a id="navi_item_search" href="/search" class="menu-item-link">
    [搜索]
  </a>
  
</div>

<hr />

  <div class="main">
    
<link rel="stylesheet" href="/css/post.css">

<post>

  <div class="post_title">
    Go八股之并发编程（1）
  </div>

  <br /><br />

  <div id="post_content">
    <h1 id="进程·线程·协程"><a href="#进程·线程·协程" class="headerlink" title="进程·线程·协程"></a>进程·线程·协程</h1><h1 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h1><p>操作系统管理 CPU、内存、磁盘 IO 等硬件资源时，会以 “进程” 为最小粒度分配。<br>不同进程的资源相互隔离。<br>若打开两个浏览器窗口，就会对应两个独立进程，各自拥有资源、独立运行。</p>
<h1 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h1><p>线程是进程内的执行单元，共享进程的内存和资源，多个线程可在同一进程内并发执行。<br>没有独立资源，依赖所属进程的资源生存。<br>CPU 调度的基本单位。</p>
<p>ps 线程切换远小于进程但是也有额外开销，需要保存线程上下文，过程设计内核态切换等，会产生时间和资源消耗。</p>
<p>大多数操作系统中一个线程默认会占用4MB内存</p>
<h1 id="协程（goroutine）"><a href="#协程（goroutine）" class="headerlink" title="协程（goroutine）"></a>协程（goroutine）</h1><p>协程是线程的轻量级实现，由go 运行时管理，即被程序控制，开销远小于线程。</p>
<p>Go Go 中一个 goroutine 初始默认占用2KB栈空间</p>
<hr>
<h1 id="GMP模型"><a href="#GMP模型" class="headerlink" title="GMP模型"></a>GMP模型</h1><p>什么是GMP模型？来收集一下G , M , P 的含义<br>G：goroutine<br>M：machine(OS threadMachine) — 线程<br>P：processor — 逻辑处理器（调度器）</p>
<h3 id="G（Goroutine）-协程"><a href="#G（Goroutine）-协程" class="headerlink" title="G（Goroutine）- 协程"></a>G（Goroutine）- 协程</h3><p><strong>定义</strong>：Go中的轻量级线程，由Go运行时管理<br><strong>特点</strong>：<br>  初始栈大小仅<strong>2KB</strong>，可动态增长<br>  创建和销毁开销极小<br>  由Go调度器管理，不依赖操作系统线程调度<br><strong>状态</strong>：<br>  <code>Grunnable</code>: 可运行状态，等待被调度<br>  <code>Grunning</code>: 正在运行状态<br>  <code>Gwaiting</code>: 等待状态（如等待I&#x2F;O、channel操作）</p>
<h3 id="M（Machine）-系统线程"><a href="#M（Machine）-系统线程" class="headerlink" title="M（Machine）- 系统线程"></a>M（Machine）- 系统线程</h3><p><strong>定义</strong>：操作系统的原生线程，真正执行代码的实体<br><strong>特点</strong>：<br>  对应操作系统的一个线程<br>  默认最大数量：<strong>10000</strong>个（可通过<code>GOMAXPROCS</code>调整）<br>  当M阻塞时，Go会创建新的M来保证并发执行<br><strong>生命周期</strong>：由Go运行时动态创建和销毁</p>
<h3 id="P（Processor）-逻辑处理器"><a href="#P（Processor）-逻辑处理器" class="headerlink" title="P（Processor）- 逻辑处理器"></a>P（Processor）- 逻辑处理器</h3><p><strong>定义</strong>：调度器，负责G和M之间的调度协调<br><strong>特点</strong>：<br>  数量等于<code>GOMAXPROCS</code>设置值（默认等于CPU核心数）<br>  维护一个本地的G队列（<code>runqueue</code>）<br>  拥有执行G所需的资源和上下文<br><strong>作用</strong>：<br>  管理G的调度<br>  提供执行环境<br>  实现工作窃取（work stealing）</p>
<h2 id="GMP调度机制"><a href="#GMP调度机制" class="headerlink" title="GMP调度机制"></a>GMP调度机制</h2><h4 id="1-本地队列优先"><a href="#1-本地队列优先" class="headerlink" title="1. 本地队列优先"></a>1. <strong>本地队列优先</strong></h4><ul>
<li>P首先从自己的本地队列中获取G执行</li>
<li>本地队列为<strong>无锁队列</strong>，访问效率高</li>
</ul>
<h4 id="2-工作窃取（Work-Stealing）"><a href="#2-工作窃取（Work-Stealing）" class="headerlink" title="2. 工作窃取（Work Stealing）"></a>2. <strong>工作窃取（Work Stealing）</strong></h4><ul>
<li>当P的本地队列为空时，从其他P的队列中”偷取”一半的G</li>
<li>减少线程空闲，提高CPU利用率</li>
</ul>
<h4 id="3-全局队列"><a href="#3-全局队列" class="headerlink" title="3. 全局队列"></a>3. <strong>全局队列</strong></h4><ul>
<li>当本地队列和其他P队列都为空时，从全局队列获取G</li>
<li>全局队列需要加锁，访问开销较大</li>
</ul>
<h2 id="g0"><a href="#g0" class="headerlink" title="g0"></a>g0</h2><ul>
<li>在GMP模型中，M结构体里面有一个特殊的g叫做g0</li>
<li>每个M在创建之初就会绑定一个g0</li>
<li>g0负责比如：垃圾回收、调度协程、调度系统调用等</li>
</ul>
<h2 id="协程调度四种策略"><a href="#协程调度四种策略" class="headerlink" title="协程调度四种策略"></a>协程调度四种策略</h2><h4 id="1-协作式调度-Cooperative-Scheduling"><a href="#1-协作式调度-Cooperative-Scheduling" class="headerlink" title="1. 协作式调度 (Cooperative Scheduling)"></a>1. 协作式调度 (Cooperative Scheduling)</h4><ul>
<li>goroutine会主动让出CPU，并等待下次调度,主要在以下情况<ul>
<li>系统调用：如time.Sleep、网络I&#x2F;O等</li>
<li>channel操作：发送或接收数据</li>
<li>函数调用：在函数调用点检查是否需要调度</li>
<li>手动调度：调用runtime.Gosched()</li>
</ul>
</li>
<li>但缺点是如果一个goroutine长时间运行且不主动让出CPU，会导致其他goroutine”饿死”。<br>例如：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DeadLoop</span><span class="hljs-params">()</span></span>&#123;  <br>    <span class="hljs-keyword">for</span>&#123;<br><br>    &#125;<br>&#125;  <br></code></pre></td></tr></table></figure>

<h4 id="2-抢占式调度-Preemptive-Scheduling"><a href="#2-抢占式调度-Preemptive-Scheduling" class="headerlink" title="2. 抢占式调度 (Preemptive Scheduling)"></a>2. 抢占式调度 (Preemptive Scheduling)</h4><ul>
<li><p>抢占式调度的触发条件</p>
<ul>
<li>执行时间过长：通常约10ms</li>
<li>计算密集型任务：没有主动进行系统调用或调度让出行为</li>
<li>函数调用链：在函数调用时检查是否需要抢占</li>
</ul>
</li>
<li><p>抢占式调用实现</p>
<ul>
<li>基于信号的抢占：使用操作系统信号机制中断goroutine执行</li>
<li>安全点检查：在函数调用等安全点检查是否需要抢占</li>
<li>调度点标记：在编译时插入调度检查</li>
</ul>
</li>
</ul>

  </div>

  <br />

  
  <br /><br />


  

<div id="copyright">

  <a id="license-image" rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img height="15" width="80" alt="知识共享 署名-非商业性使用-相同方式共享 4.0 国际许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" />
  </a>

  <p id="license-word-hyper">
    本作品采用
    <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
    知识共享 署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>
    进行许可。
  </p>
</div>

  <div id="top">
  <div onclick="window.scrollTo({top: 0, behavior: 'smooth'})">▲</div>
  <div onclick="document.getElementById('footer').scrollIntoView({behavior: 'smooth'})">▼</div>
</div>
  

</post>
  </div>

  <foot id="footer">
  <hr class="boldline" />
  <br>

  <p class="center font">
    
    <a target="_blank" rel="noopener" href="https://github.com/UndertaK33r" aria-label="GitHub">
  <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
   <path class="icon_path" d="M427.392 853.504a61.44 61.44 0 0 1-1.450667 15.530667 92.586667 92.586667 0 0 1-10.965333 27.605333c-15.061333 25.301333-40.661333 42.154667-73.642667 42.154667-77.653333 0-108.117333-38.101333-146.261333-133.504C169.216 740.693333 157.013333 725.461333 128 725.461333v-85.333333c77.653333 0 108.117333 38.101333 146.261333 133.504 25.856 64.597333 38.058667 79.786667 67.072 79.786667 0-12.373333-0.170667-23.296-0.512-38.144-0.853333-34.816-0.938667-41.941333 0.554667-51.2 0.64-20.352 5.888-34.773333 16.384-49.066667-95.232-20.736-159.445333-63.573333-196.309333-132.992l-13.824-32.426667C134.186667 510.848 128 467.072 128 416.426667c0-58.24 17.749333-110.336 50.944-153.856-10.368-41.386667-8.96-91.989333 13.909333-149.077334l7.466667-18.688 19.2-6.101333c2.56-0.853333 5.632-1.578667 9.301333-2.133333 37.290667-5.888 90.325333 8.106667 159.701334 52.48a565.930667 565.930667 0 0 1 127.274666-14.208c38.741333 0 77.226667 3.882667 114.048 11.605333 67.456-42.24 119.04-55.509333 155.306667-49.92 3.626667 0.597333 6.741333 1.322667 9.258667 2.133333l19.285333 6.101334 7.466667 18.773333c20.010667 50.218667 23.424 96.469333 16.128 136.96C875.434667 296.32 896 352.597333 896 416.512c0 53.888-3.84 94.378667-14.933333 133.802667l-11.733334 32.170666c-30.677333 69.333333-98.304 112.64-202.538666 133.248 10.837333 15.018667 15.872 30.250667 15.872 52.394667v42.666667l-0.042667 42.666666a13.013333 13.013333 0 0 0 0.341333 2.730667L682.666667 938.794667c-36.352 0-63.36-17.706667-76.672-45.653334a88.277333 88.277333 0 0 1-8.661334-40.277333v-84.736c0-3.584-0.128-3.797333-8.832-12.501333-23.296-23.296-33.834667-40.874667-33.834666-72.832v-38.613334l38.4-3.84c114.346667-11.52 176.512-43.221333 197.12-89.6l9.6-26.325333c7.68-27.562667 10.88-61.098667 10.88-107.946667 0-49.706667-17.365333-90.837333-50.218667-123.648L742.4 274.773333l7.381333-24.448c6.528-21.717333 8.106667-47.402667 1.152-76.714666a158.634667 158.634667 0 0 0-3.584 0.938666c-22.826667 6.4-51.370667 20.053333-85.76 43.008l-15.658666 10.453334-18.304-4.522667a467.754667 467.754667 0 0 0-111.829334-13.269333c-42.709333 0-84.906667 5.418667-123.946666 16.042666l-19.029334 5.205334-16.256-11.136c-35.541333-24.32-65.109333-38.826667-88.746666-45.568a158.293333 158.293333 0 0 0-4.864-1.28c-8.234667 33.92-4.992 61.781333 3.413333 82.688l9.984 25.088-18.346667 19.797333C228.693333 332.629333 213.333333 370.986667 213.333333 416.512c0 41.685333 4.864 76.202667 13.824 102.229333l11.178667 26.453334c27.904 52.352 87.168 83.84 192.853333 95.146666l38.144 4.096v38.357334c0 32-10.538667 49.536-33.834666 72.832-8.704 8.704-8.832 8.96-8.832 12.501333l-0.725334 7.893333c-0.512 2.56-0.512 9.258667 0.170667 37.205334 0.298667 12.8 0.469333 22.997333 0.554667 33.621333a33.962667 33.962667 0 0 1 0.725333 6.656z"/>
  </svg>
 </a>

    
    
    <a href="mailto:2331627921@qq.com" aria-label="Email">
  <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <path d="M513.78 602.99c-27.28 0.45-53.79-9.09-74.53-26.83l-65.96-56.64c-15.64-13.37-17.48-36.9-4.1-52.54 13.38-15.65 36.9-17.48 52.54-4.1l65.96 56.64c13.68 11.1 33.27 11.1 46.95 0L881.2 253.08l-708.02-2.61c-20.58 0-37.26-16.69-37.26-37.26s16.68-37.26 37.26-37.26H881.2c41.09-2.36 76.32 29.05 78.67 70.14a74.519 74.519 0 0 1-32.46 65.87L580.86 578.38a111.842 111.842 0 0 1-67.08 24.61z m444.57 133.4V438.28c0-20.58-16.68-37.26-37.26-37.26s-37.26 16.69-37.26 37.26V736.4c0 20.58-16.68 37.26-37.26 37.26h-521.7c-20.58 0-37.26 16.69-37.26 37.26s16.68 37.26 37.26 37.26h521.7c61.72 0.01 111.78-50.05 111.78-111.79zM362.12 363.75c0-20.58-16.68-37.26-37.26-37.26h-223.6c-20.58 0-37.26 16.69-37.26 37.26s16.68 37.26 37.26 37.26h223.59c20.58 0.01 37.27-16.68 37.27-37.26z m0 298.12c0-20.58-16.68-37.26-37.26-37.26h-111.8c-20.58 0-37.26 16.69-37.26 37.26s16.68 37.26 37.26 37.26h111.79c20.58 0 37.27-16.69 37.27-37.26z"/>
  </svg>
</a>

    
    
    
    
    
    
    
    
    
  <p>
    <br>
  <p id="hitokoto">:D 获取中...</p>
  <script src="https://v1.hitokoto.cn/?c=a&encode=js&select=%23hitokoto" defer></script>
  <br>
  <p class="center font">
    &copy - <a href="https://UndertaK33r.github.io">UndertaK33r</a> -  2025 - Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/pcrab/hexo-theme-quark"> Quark </a> 
  </p>
  
  <br />
</foot>
  
  
  
<script src="/js/perf-toggle.js"></script>

</body>

</html>