<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <title>
    
    Goè¯­è¨€AIå®è·µè¿‡ç¨‹ï¼ˆ3ï¼‰ - 
    Undertaker&#39;s Blog
  </title>
  <meta property="og:title" content="Goè¯­è¨€AIå®è·µè¿‡ç¨‹ï¼ˆ3ï¼‰ - Undertaker&#39;s Blog" />
  <meta property="og:site_name" content="Undertaker&#39;s Blog" />

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  

  <meta property="og:type" content="article" />


  
  <link rel="shortcut icon" href="/mylogo.ico" />
  

  

  
  <link rel="canonical" href="https://undertak33r.github.io/2025/10/09/Go%E8%AF%AD%E8%A8%80AI%E5%AE%9E%E8%B7%B5%E8%BF%87%E7%A8%8B%EF%BC%883%EF%BC%89/">
  <meta name="og:url" content="https://undertak33r.github.io/2025/10/09/Go%E8%AF%AD%E8%A8%80AI%E5%AE%9E%E8%B7%B5%E8%BF%87%E7%A8%8B%EF%BC%883%EF%BC%89/">
  
  <!-- ç°ä»£åŒ–å­—ä½“åŠ è½½ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <!-- particles.js åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  
  
<link rel="stylesheet" href="/css/style.css">


<meta name="generator" content="Hexo 8.0.0"></head>

<body>
  

  <div class="title">
  <img class="title_img" alt="Title image" width="300" height="300" src="/images/mylogo.jpg" /><br>
  <div id="site_title">Undertaker's Blog</div>
</div>
  <div class="navi">
  <a id="navi_item_title" href="/#" class="menu-item-link">
    [ä¸»é¡µ]
  </a>
  <a id="navi_item_tags" href="/tags" class="menu-item-link">
    [æ ‡ç­¾]
  </a>
  <a id="navi_item_about" href="/about" class="menu-item-link">
    [å…³äº]
  </a>
  <a id="navi_item_search" href="/search" class="menu-item-link">
    [æœç´¢]
  </a>
  
</div>

<hr />

  <div class="main">
    
<link rel="stylesheet" href="/css/post.css">

<post>

  <div class="post_title">
    Goè¯­è¨€AIå®è·µè¿‡ç¨‹ï¼ˆ3ï¼‰
  </div>

  <br /><br />

  <div id="post_content">
    <p>åœ¨ä¸Šä¸¤ç¯‡ä¸­å®ç°äº†ä¸€ä¸ªèƒ½è°ƒç”¨çš„å‡½æ•°ï¼Œé‡Œé¢å®ç°äº†è°ƒç”¨llmå’ŒæŒä¹…åŒ–å¯¹è¯è®°å½•çš„åŠŸèƒ½ã€‚<br>ä¸è¿‡å•çº¯çš„è°ƒç”¨å®åœ¨æ˜¯æ²¡å•¥æ„æ€ï¼Œæ¥ä¸‹æ¥æŠŠé¡¹ç›®é‡Œé¢çš„ä¸€äº›ç¡¬ç¼–ç çš„å†…å®¹æ•´åˆä¸€ä¸‹è¿›è¡Œé…ç½®åŒ–ã€‚<br>åŒæ—¶æˆ‘ä»¬çš„å‡½æ•°æ˜¯ä¸€æ¬¡æ€§ç”Ÿæˆä¸€å¤§å¨ï¼Œè¿™æ ·çš„ä½“éªŒå¾ˆä¸å¥½ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å†…å®¹æ”¹æˆæµå¼è¾“å‡ºã€‚</p>
<h3 id="é…ç½®åŒ–"><a href="#é…ç½®åŒ–" class="headerlink" title="é…ç½®åŒ–"></a>é…ç½®åŒ–</h3><p>å…ˆæŠŠä¹‹å‰ç¡¬ç¼–ç åœ¨mainæ–‡ä»¶é‡Œçš„å†…å®¹ç”¨yamlæ–‡ä»¶è£…èµ·æ¥ï¼Œåç»­æœ‰æ–°çš„é…ç½®ä¹Ÿå¯ä»¥å†™åœ¨é‡Œé¢<br>æˆ‘ä»¬ç›´æ¥åœ¨æ ¹ç›®å½•ä¸‹å»ºä¸€ä¸ªconfig.yamlæ–‡ä»¶</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># AI å¯¹è¯åŠ©æ‰‹é…ç½®æ–‡ä»¶</span><br><br><span class="hljs-comment"># API é…ç½®</span><br><span class="hljs-attr">api:</span><br>  <span class="hljs-attr">url:</span> <span class="hljs-string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions&quot;</span><br>  <span class="hljs-attr">key:</span> <span class="hljs-string">&quot;ä½ çš„apikey&quot;</span>  <span class="hljs-comment"># å»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡ DASHSCOPE_API_KEY</span><br>  <span class="hljs-attr">model:</span> <span class="hljs-string">&quot;qwen-plus&quot;</span><br>  <span class="hljs-attr">prompt:</span> <span class="hljs-string">&quot;ä½ æ˜¯ä¸€ä¸ªè¯´è¯ç®€æ´ç›´æ¥çš„åŠ©æ‰‹&quot;</span><br><br><span class="hljs-comment"># MongoDB é…ç½®</span><br><span class="hljs-attr">mongo:</span><br>  <span class="hljs-attr">uri:</span> <span class="hljs-string">&quot;mongodb://localhost:27017&quot;</span><br>  <span class="hljs-attr">database:</span> <span class="hljs-string">&quot;qwen&quot;</span><br>  <span class="hljs-attr">collection:</span> <span class="hljs-string">&quot;messages&quot;</span><br><br><span class="hljs-comment"># Agent é…ç½®</span><br><span class="hljs-attr">agent:</span><br>  <span class="hljs-attr">history_size:</span> <span class="hljs-number">50</span>  <span class="hljs-comment"># å†å²æ¶ˆæ¯æ•°é‡</span><br>  <span class="hljs-attr">session_id:</span> <span class="hljs-number">1</span>     <span class="hljs-comment"># é»˜è®¤ä¼šè¯ID</span><br></code></pre></td></tr></table></figure>
<p>å†™å®Œyamlæ–‡ä»¶ä¹‹åéœ€è¦æŠŠè¿™äº›å†…å®¹è¯»å–<br>æˆ‘ä»¬å»ºä¸€ä¸ªconfigæ–‡ä»¶å¤¹ç„¶åé‡Œé¢åˆ›å»ºä¸€ä¸ªconfig.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> config<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;os&quot;</span><br><br>	<span class="hljs-string">&quot;gopkg.in/yaml.v3&quot;</span><br>)<br><br><span class="hljs-comment">// Config åº”ç”¨é…ç½®ç»“æ„</span><br><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> &#123;<br>	API   APIConfig   <span class="hljs-string">`yaml:&quot;api&quot;`</span><br>	Mongo MongoConfig <span class="hljs-string">`yaml:&quot;mongo&quot;`</span><br>	Agent AgentConfig <span class="hljs-string">`yaml:&quot;agent&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// APIConfig APIé…ç½®</span><br><span class="hljs-keyword">type</span> APIConfig <span class="hljs-keyword">struct</span> &#123;<br>	URL    <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;url&quot;`</span><br>	Key    <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;key&quot;`</span><br>	Model  <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;model&quot;`</span><br>	Prompt <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;prompt&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// MongoConfig MongoDBé…ç½®</span><br><span class="hljs-keyword">type</span> MongoConfig <span class="hljs-keyword">struct</span> &#123;<br>	URI            <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;uri&quot;`</span><br>	Database       <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;database&quot;`</span><br>	Collection     <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;collection&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// AgentConfig Agenté…ç½®</span><br><span class="hljs-keyword">type</span> AgentConfig <span class="hljs-keyword">struct</span> &#123;<br>	HistorySize <span class="hljs-type">int</span> <span class="hljs-string">`yaml:&quot;history_size&quot;`</span><br>	SessionID   <span class="hljs-type">int</span> <span class="hljs-string">`yaml:&quot;session_id&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// LoadConfig ä»YAMLæ–‡ä»¶åŠ è½½é…ç½®</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadConfig</span><span class="hljs-params">(filepath <span class="hljs-type">string</span>)</span></span> (*Config, <span class="hljs-type">error</span>) &#123;<br>	data, err := os.ReadFile(filepath)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥: %w&quot;</span>, err)<br>	&#125;<br><br>	<span class="hljs-keyword">var</span> config Config<br>	<span class="hljs-keyword">if</span> err := yaml.Unmarshal(data, &amp;config); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;è§£æé…ç½®æ–‡ä»¶å¤±è´¥: %w&quot;</span>, err)<br>	&#125;<br><br>	<span class="hljs-comment">// ä»ç¯å¢ƒå˜é‡è¦†ç›–æ•æ„Ÿä¿¡æ¯</span><br>	<span class="hljs-keyword">if</span> apiKey := os.Getenv(<span class="hljs-string">&quot;DASHSCOPE_API_KEY&quot;</span>); apiKey != <span class="hljs-string">&quot;&quot;</span> &#123;<br>		config.API.Key = apiKey<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> &amp;config, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// GetDefaultConfig è·å–é»˜è®¤é…ç½®</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetDefaultConfig</span><span class="hljs-params">()</span></span> *Config &#123;<br>	<span class="hljs-keyword">return</span> &amp;Config&#123;<br>		API: APIConfig&#123;<br>			URL:    <span class="hljs-string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions&quot;</span>,<br>			Key:    <span class="hljs-string">&quot;&quot;</span>,<br>			Model:  <span class="hljs-string">&quot;qwen-plus&quot;</span>,<br>			Prompt: <span class="hljs-string">&quot;ä½ æ˜¯ä¸€ä¸ªè¯´è¯ç®€æ´ç›´æ¥çš„åŠ©æ‰‹&quot;</span>,<br>		&#125;,<br>		Mongo: MongoConfig&#123;<br>			URI:        <span class="hljs-string">&quot;mongodb://localhost:27017&quot;</span>,<br>			Database:   <span class="hljs-string">&quot;qwen&quot;</span>,<br>			Collection: <span class="hljs-string">&quot;messages&quot;</span>,<br>		&#125;,<br>		Agent: AgentConfig&#123;<br>			HistorySize: <span class="hljs-number">50</span>,<br>			SessionID:   <span class="hljs-number">1</span>,<br>		&#125;,<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>å¦‚æœè¯»å–é…ç½®æ–‡ä»¶å¤±è´¥æˆ‘ä»¬å°±é‡‡ç”¨é»˜è®¤é…ç½®ï¼Œä¹Ÿå°±æ˜¯ç¬¬äºŒä¸ªå‡½æ•°ï¼Œç¨åä¼šåœ¨mainæ–‡ä»¶é‡Œçœ‹åˆ°å¦‚ä½•ä½¿ç”¨ä»–ä»¬</p>
<h3 id="æµå¼è¾“å‡º"><a href="#æµå¼è¾“å‡º" class="headerlink" title="æµå¼è¾“å‡º"></a>æµå¼è¾“å‡º</h3><p>åœ¨æ­¤ä¹‹å‰çœ‹çœ‹æ–‡æ¡£æŠŠç”¨curlæ¥è¯·æ±‚aiçš„æµå¼è¾“å‡ºè´´å‡ºæ¥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -X POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions \<br>-H <span class="hljs-string">&quot;Authorization: Bearer <span class="hljs-variable">$DASHSCOPE_API_KEY</span>&quot;</span> \<br>-H <span class="hljs-string">&quot;Content-Type: application/json&quot;</span> \<br>--no-buffer \<br>-d <span class="hljs-string">&#x27;&#123;</span><br><span class="hljs-string">    &quot;model&quot;: &quot;qwen-plus&quot;,</span><br><span class="hljs-string">    &quot;messages&quot;: [</span><br><span class="hljs-string">        &#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;ä½ æ˜¯è°ï¼Ÿ&quot;&#125;</span><br><span class="hljs-string">    ],</span><br><span class="hljs-string">    &quot;stream&quot;: true,</span><br><span class="hljs-string">    &quot;stream_options&quot;: &#123;&quot;include_usage&quot;: true&#125;</span><br><span class="hljs-string">&#125;&#x27;</span><br><br></code></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çœ‹åˆ°apiè¯·æ±‚é‡Œé¢å¤šäº†ä¸ªstreamï¼štrue</p>
<p>ç„¶åæˆ‘ä»¬ç”¨postmanæ¥æµ‹è¯•ä¸€ä¸‹çœ‹çœ‹ä¼šè¿”å›é‚£äº›å‚æ•°</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;choices&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;delta&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;role&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;assistant&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;logprobs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;finish_reason&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;object&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;chat.completion.chunk&quot;</span><br>  ...<br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<p>è¿™é‡Œé¢å’Œä¹‹å‰çš„è¿”å›ç»“æ„ä¸åŒï¼Œæˆ‘ä»¬æå–ä¸€äº›å…³é”®çš„å‚æ•°<br>ä»¥æ­¤æˆ‘ä»¬æ¥æ”¹é€ ä¸€ä¸‹æˆ‘ä»¬çš„model.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Message <span class="hljs-keyword">struct</span> &#123;<br>	Role      <span class="hljs-type">string</span> <span class="hljs-string">`bson:&quot;role&quot;`</span><br>	Content   <span class="hljs-type">string</span> <span class="hljs-string">`bson:&quot;content&quot;`</span><br>	SessionId <span class="hljs-type">int</span>    <span class="hljs-string">`bson:&quot;sessionId,omitempty&quot;`</span> <span class="hljs-comment">// æ·»åŠ ä¼šè¯ID</span><br>&#125;<br><span class="hljs-keyword">type</span> MessageVO <span class="hljs-keyword">struct</span> &#123;<br>	Role    <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;role&quot;`</span><br>	Content <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;content&quot;`</span><br>&#125;<br><br><span class="hljs-keyword">type</span> APIRequest <span class="hljs-keyword">struct</span> &#123;<br>	Model    <span class="hljs-type">string</span>      <span class="hljs-string">`json:&quot;model&quot;`</span><br>	Messages []MessageVO <span class="hljs-string">`json:&quot;messages&quot;`</span><br>	Stream   <span class="hljs-type">bool</span>        <span class="hljs-string">`json:&quot;stream,omitempty&quot;`</span> <span class="hljs-comment">// æ·»åŠ æµå¼å‚æ•°-------------è¿™æ˜¯æ–°çš„</span><br>&#125;<br><br><span class="hljs-keyword">type</span> Response <span class="hljs-keyword">struct</span> &#123; <span class="hljs-comment">//å°è£…è¿”å›ç»“æœ</span><br>	Choices []<span class="hljs-keyword">struct</span> &#123;<br>		Message <span class="hljs-keyword">struct</span> &#123;<br>			<span class="hljs-comment">//Role    string `json:&quot;role&quot;` // ç³»ç»Ÿè§’è‰²ä¸å¤ªéœ€è¦å±•ç¤º,ä½†ä¹Ÿå…ˆè£…èµ·æ¥</span><br>			Content <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;content&quot;`</span><br>		&#125; <span class="hljs-string">`json:&quot;message&quot;`</span><br>	&#125; <span class="hljs-string">`json:&quot;choices&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// StreamResponse æµå¼å“åº”ç»“æ„-----------------------------------------------</span><br><span class="hljs-keyword">type</span> StreamResponse <span class="hljs-keyword">struct</span> &#123;<br>	Choices []<span class="hljs-keyword">struct</span> &#123;<br>		Delta <span class="hljs-keyword">struct</span> &#123;<br>			Content <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;content&quot;`</span><br>		&#125; <span class="hljs-string">`json:&quot;delta&quot;`</span><br>		FinishReason <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;finish_reason&quot;`</span><br>	&#125; <span class="hljs-string">`json:&quot;choices&quot;`</span><br>&#125;<br>    .....<br>    .....<br>	<span class="hljs-comment">// å¦‚æœæœ‰è¿”å›å†…å®¹ï¼Œå­˜å‚¨åˆ°æ•°æ®åº“</span><br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(response.Choices) &gt; <span class="hljs-number">0</span> &#123;<br>		reply := response.Choices[<span class="hljs-number">0</span>].Message.Content<br>		a.saveMessage(Message&#123;<br>			SessionId: message.SessionId,<br>			Role:      <span class="hljs-string">&quot;assistant&quot;</span>,<br>			Content:   reply,<br>		&#125;)<br>	&#125;<br>	<span class="hljs-keyword">return</span> &amp;response, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// ChatStream æµå¼å¯¹è¯æ–¹æ³•-------------------------------------------</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *Agent)</span></span> ChatStream(ctx context.Context, message Message, onChunk <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(<span class="hljs-type">string</span>)</span></span>) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br>	a.mutex.Lock()<br>	<span class="hljs-keyword">defer</span> a.mutex.Unlock()<br><br>	err := a.saveMessage(message)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>	&#125;<br><br>	<span class="hljs-comment">// è·å–æœ€è¿‘æ¶ˆæ¯</span><br>	recentMessages, err := a.getRecentMessages(a.size, message.SessionId)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>	&#125;<br><br>	apiRequest := APIRequest&#123;<br>		Model:    a.model,<br>		Messages: recentMessages,<br>		Stream:   <span class="hljs-literal">true</span>, <span class="hljs-comment">// å¯ç”¨æµå¼è¾“å‡º</span><br>	&#125;<br><br>	jsonData, err := json.Marshal(apiRequest)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>	&#125;<br><br>	req, err := http.NewRequestWithContext(ctx, <span class="hljs-string">&quot;POST&quot;</span>, a.baseURL, bytes.NewBuffer(jsonData))<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>	&#125;<br><br>	req.Header.Set(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/json&quot;</span>)<br>	req.Header.Set(<span class="hljs-string">&quot;Authorization&quot;</span>, <span class="hljs-string">&quot;Bearer &quot;</span>+a.apiKey)<br>	<span class="hljs-comment">//req.Header.Set(&quot;X-DashScope-SSE&quot;, &quot;enable&quot;) // dashscopeå¯ç”¨æµå¼è¾“å‡º</span><br><br>	client := &amp;http.Client&#123;&#125;<br>	resp, err := client.Do(req)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>	&#125;<br>	<span class="hljs-keyword">defer</span> resp.Body.Close()<br><br>	<span class="hljs-comment">// è¯»å–æµå¼å“åº”</span><br>	<span class="hljs-keyword">var</span> fullContent strings.Builder<br>	reader := bufio.NewReader(resp.Body)<br><br>	<span class="hljs-keyword">for</span> &#123;<br>		line, err := reader.ReadString(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">if</span> err == io.EOF &#123;<br>				<span class="hljs-keyword">break</span><br>			&#125;<br>			<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>		&#125;<br><br>		line = strings.TrimSpace(line)<br>		<span class="hljs-keyword">if</span> line == <span class="hljs-string">&quot;&quot;</span> || !strings.HasPrefix(line, <span class="hljs-string">&quot;data:&quot;</span>) &#123;<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br><br>		<span class="hljs-comment">// ç§»é™¤ &quot;data: &quot; å‰ç¼€</span><br>		data := strings.TrimPrefix(line, <span class="hljs-string">&quot;data:&quot;</span>)<br>		data = strings.TrimSpace(data)<br><br>		<span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦æ˜¯ç»“æŸæ ‡è®°</span><br>		<span class="hljs-keyword">if</span> data == <span class="hljs-string">&quot;[DONE]&quot;</span> &#123;<br>			<span class="hljs-keyword">break</span><br>		&#125;<br><br>		<span class="hljs-comment">// è§£æ JSON</span><br>		<span class="hljs-keyword">var</span> streamResp StreamResponse<br>		<span class="hljs-keyword">if</span> err := json.Unmarshal([]<span class="hljs-type">byte</span>(data), &amp;streamResp); err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br><br>		<span class="hljs-comment">// æå–å†…å®¹</span><br>		<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(streamResp.Choices) &gt; <span class="hljs-number">0</span> &#123;<br>			content := streamResp.Choices[<span class="hljs-number">0</span>].Delta.Content<br>			<span class="hljs-keyword">if</span> content != <span class="hljs-string">&quot;&quot;</span> &#123;<br>				fullContent.WriteString(content)<br>				<span class="hljs-keyword">if</span> onChunk != <span class="hljs-literal">nil</span> &#123;<br>					onChunk(content) <span class="hljs-comment">// å›è°ƒå‡½æ•°å¤„ç†æ¯ä¸ªchunk</span><br>				&#125;<br>			&#125;<br><br>			<span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦å®Œæˆ</span><br>			<span class="hljs-keyword">if</span> streamResp.Choices[<span class="hljs-number">0</span>].FinishReason != <span class="hljs-string">&quot;&quot;</span> &#123;<br>				<span class="hljs-keyword">break</span><br>			&#125;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// ä¿å­˜å®Œæ•´çš„å›å¤åˆ°æ•°æ®åº“</span><br>	reply := fullContent.String()<br>	<span class="hljs-keyword">if</span> reply != <span class="hljs-string">&quot;&quot;</span> &#123;<br>		err = a.saveMessage(Message&#123;<br>			SessionId: message.SessionId,<br>			Role:      <span class="hljs-string">&quot;assistant&quot;</span>,<br>			Content:   reply,<br>		&#125;)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> reply, err<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> reply, <span class="hljs-literal">nil</span><br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>æ–°çš„å‡½æ•°æœ‰Â·é•¿ï¼Œæˆ‘æ¥ç¨å¾®è§£é‡Šä¸€ä¸‹ã€‚<br>é¦–å…ˆæ˜¯å’Œæ™®é€šmodelä¸€æ ·ï¼Œæ‹¿åˆ°è¿‡å»çš„å¯¹è¯ä¿¡æ¯ï¼ŒåŒ…è£…æˆapiè¯·æ±‚ç„¶åå‘èµ·<br>ä¸ä¸€æ ·çš„ç‚¹åœ¨äºæ¥å—å“åº”çš„éƒ¨åˆ†<br>å…ˆç”¨readeræŒç»­æŒ‰è¡Œè¯»å–å“åº”çš„body<br>ç”¨dataæ¥æŠŠä¸€äº›æ¢è¡Œç¬¦è¿˜æœ‰ä¸€äº›æ‚ä¸ƒæ‚å…«çš„å»æ‰ã€‚<br>åŒæ—¶dataè¿˜è¦æ£€æŸ¥æ˜¯å¦å“åº”ç»“æŸï¼Œå¦‚æœ[DONE]äº†å°±ç»“æŸå¤„ç†<br>æ²¡æœ‰ç»“æŸå°±æŠŠå†…å®¹éƒ½è§£æåˆ°æˆ‘ä»¬çš„å®šä¹‰çš„respå˜é‡é‡Œé¢<br>æŠŠrespé‡Œé¢çš„å­—ç¬¦ä¸²åŠ åˆ°builderé‡Œé¢å»ï¼Œå¦‚æœå¾—åˆ°çš„å†…å®¹ä¸ä¸ºç©ºå°±æ‰§è¡ŒonChunkå‡½æ•°<br>æœ€åä¾æ—§æ˜¯ä¿å­˜</p>
<p>å…ˆåˆ«ç®¡onChunkå‡½æ•°æ˜¯å¹²ä»€ä¹ˆçš„åé¢èƒ½çœ‹åˆ°<br>æœ€åæ˜¯å†™ä¸€ä¸ªæ§åˆ¶å°äº¤äº’çš„æ–‡ä»¶<br>ç›´æ¥è´´åœ¨ä¸‹é¢<br>console.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> console<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bufio&quot;</span><br>	<span class="hljs-string">&quot;context&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;model/model&quot;</span><br>	<span class="hljs-string">&quot;os&quot;</span><br>	<span class="hljs-string">&quot;strings&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-comment">// é¢œè‰²ä»£ç </span><br><span class="hljs-keyword">const</span> (<br>	ColorReset  = <span class="hljs-string">&quot;\033[0m&quot;</span><br>	ColorRed    = <span class="hljs-string">&quot;\033[31m&quot;</span><br>	ColorGreen  = <span class="hljs-string">&quot;\033[32m&quot;</span><br>	ColorYellow = <span class="hljs-string">&quot;\033[33m&quot;</span><br>	ColorBlue   = <span class="hljs-string">&quot;\033[34m&quot;</span><br>	ColorPurple = <span class="hljs-string">&quot;\033[35m&quot;</span><br>	ColorCyan   = <span class="hljs-string">&quot;\033[36m&quot;</span><br>	ColorWhite  = <span class="hljs-string">&quot;\033[37m&quot;</span><br>	ColorBold   = <span class="hljs-string">&quot;\033[1m&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> Console <span class="hljs-keyword">struct</span> &#123;<br>	agent     *model.Agent<br>	sessionID <span class="hljs-type">int</span><br>	reader    *bufio.Reader<br>&#125;<br><br><span class="hljs-comment">// NewConsole åˆ›å»ºæ–°çš„æ§åˆ¶å°å®ä¾‹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewConsole</span><span class="hljs-params">(agent *model.Agent, sessionID <span class="hljs-type">int</span>)</span></span> *Console &#123;<br>	<span class="hljs-keyword">return</span> &amp;Console&#123;<br>		agent:     agent,<br>		sessionID: sessionID,<br>		reader:    bufio.NewReader(os.Stdin),<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// printWelcome æ‰“å°æ¬¢è¿ä¿¡æ¯</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Console)</span></span> printWelcome() &#123;<br>	fmt.Println(ColorCyan + ColorBold + <span class="hljs-string">&quot;â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—&quot;</span> + ColorReset)<br>	fmt.Println(ColorCyan + ColorBold + <span class="hljs-string">&quot;â•‘          æ¬¢è¿ä½¿ç”¨ AI æ™ºèƒ½å¯¹è¯åŠ©æ‰‹ (æµå¼ç‰ˆæœ¬)              â•‘&quot;</span> + ColorReset)<br>	fmt.Println(ColorCyan + ColorBold + <span class="hljs-string">&quot;â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•&quot;</span> + ColorReset)<br>	fmt.Println()<br>	fmt.Println(ColorYellow + <span class="hljs-string">&quot;ğŸ’¡ ä½¿ç”¨è¯´æ˜:&quot;</span> + ColorReset)<br>	fmt.Println(<span class="hljs-string">&quot;  â€¢ ç›´æ¥è¾“å…¥æ¶ˆæ¯å¼€å§‹å¯¹è¯&quot;</span>)<br>	fmt.Println(<span class="hljs-string">&quot;  â€¢ è¾“å…¥ &#x27;exit&#x27; æˆ– &#x27;quit&#x27; é€€å‡ºç¨‹åº&quot;</span>)<br>	fmt.Println(<span class="hljs-string">&quot;  â€¢ è¾“å…¥ &#x27;clear&#x27; æ¸…ç©ºå±å¹•&quot;</span>)<br>	fmt.Println(<span class="hljs-string">&quot;  â€¢ è¾“å…¥ &#x27;help&#x27; æŸ¥çœ‹å¸®åŠ©&quot;</span>)<br>	fmt.Println()<br>	fmt.Println(ColorGreen + <span class="hljs-string">&quot;âœ¨ ä¼šè¯ID: &quot;</span> + fmt.Sprintf(<span class="hljs-string">&quot;%d&quot;</span>, c.sessionID) + ColorReset)<br>	fmt.Println(strings.Repeat(<span class="hljs-string">&quot;â”€&quot;</span>, <span class="hljs-number">60</span>))<br>	fmt.Println()<br>&#125;<br><br><span class="hljs-comment">// printHelp æ‰“å°å¸®åŠ©ä¿¡æ¯</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Console)</span></span> printHelp() &#123;<br>	fmt.Println()<br>	fmt.Println(ColorCyan + <span class="hljs-string">&quot;ğŸ“– å¸®åŠ©ä¿¡æ¯:&quot;</span> + ColorReset)<br>	fmt.Println(<span class="hljs-string">&quot;  exit/quit  - é€€å‡ºç¨‹åº&quot;</span>)<br>	fmt.Println(<span class="hljs-string">&quot;  clear      - æ¸…ç©ºå±å¹•&quot;</span>)<br>	fmt.Println(<span class="hljs-string">&quot;  help       - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯&quot;</span>)<br>	fmt.Println()<br>&#125;<br><br><span class="hljs-comment">// clearScreen æ¸…ç©ºå±å¹•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Console)</span></span> clearScreen() &#123;<br>	fmt.Print(<span class="hljs-string">&quot;\033[H\033[2J&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// readInput è¯»å–ç”¨æˆ·è¾“å…¥</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Console)</span></span> readInput() (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br>	fmt.Print(ColorGreen + <span class="hljs-string">&quot;ğŸ‘¤ ä½ : &quot;</span> + ColorReset)<br>	input, err := c.reader.ReadString(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>	&#125;<br>	<span class="hljs-keyword">return</span> strings.TrimSpace(input), <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// Start å¯åŠ¨æ§åˆ¶å°å¯¹è¯</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Console)</span></span> Start() <span class="hljs-type">error</span> &#123;<br>	c.printWelcome()<br><br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-comment">// è¯»å–ç”¨æˆ·è¾“å…¥</span><br>		input, err := c.readInput()<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;è¯»å–è¾“å…¥å¤±è´¥: %w&quot;</span>, err)<br>		&#125;<br><br>		<span class="hljs-comment">// å¤„ç†ç©ºè¾“å…¥</span><br>		<span class="hljs-keyword">if</span> input == <span class="hljs-string">&quot;&quot;</span> &#123;<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br><br>		<span class="hljs-comment">// å¤„ç†å‘½ä»¤</span><br>		<span class="hljs-keyword">switch</span> strings.ToLower(input) &#123;<br>		<span class="hljs-keyword">case</span> <span class="hljs-string">&quot;exit&quot;</span>, <span class="hljs-string">&quot;quit&quot;</span>:<br>			fmt.Println()<br>			fmt.Println(ColorYellow + <span class="hljs-string">&quot;ğŸ‘‹ å†è§ï¼æ„Ÿè°¢ä½¿ç”¨ï¼&quot;</span> + ColorReset)<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>		<span class="hljs-keyword">case</span> <span class="hljs-string">&quot;clear&quot;</span>:<br>			c.clearScreen()<br>			c.printWelcome()<br>			<span class="hljs-keyword">continue</span><br>		<span class="hljs-keyword">case</span> <span class="hljs-string">&quot;help&quot;</span>:<br>			c.printHelp()<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br><br>		<span class="hljs-comment">// å‘é€æ¶ˆæ¯å¹¶æ¥æ”¶æµå¼å“åº”</span><br>		fmt.Print(ColorBlue + <span class="hljs-string">&quot;ğŸ¤– åŠ©æ‰‹: &quot;</span> + ColorReset)<br><br>		startTime := time.Now()<br>		_, err = c.agent.ChatStream(context.Background(), model.Message&#123;<br>			Role:      <span class="hljs-string">&quot;user&quot;</span>,<br>			Content:   input,<br>			SessionId: c.sessionID,<br>		&#125;, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(chunk <span class="hljs-type">string</span>)</span></span> &#123;<br>			<span class="hljs-comment">// å®æ—¶æ‰“å°æ¯ä¸ªchunk</span><br>			fmt.Print(chunk)<br>		&#125;)<br><br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Println()<br>			fmt.Println(ColorRed + <span class="hljs-string">&quot;âŒ é”™è¯¯: &quot;</span> + err.Error() + ColorReset)<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br><br>		<span class="hljs-comment">// æ‰“å°å“åº”æ—¶é—´</span><br>		duration := time.Since(startTime)<br>		fmt.Println()<br>		fmt.Println(ColorPurple + fmt.Sprintf(<span class="hljs-string">&quot;â±ï¸  å“åº”æ—¶é—´: %.2fç§’&quot;</span>, duration.Seconds()) + ColorReset)<br>		fmt.Println(strings.Repeat(<span class="hljs-string">&quot;â”€&quot;</span>, <span class="hljs-number">60</span>))<br>		fmt.Println()<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// StartSimple å¯åŠ¨ç®€å•ç‰ˆæ§åˆ¶å°å¯¹è¯ï¼ˆæ— é¢œè‰²ï¼‰</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Console)</span></span> StartSimple() <span class="hljs-type">error</span> &#123;<br>	fmt.Println(<span class="hljs-string">&quot;=== AI å¯¹è¯åŠ©æ‰‹ ===&quot;</span>)<br>	fmt.Println(<span class="hljs-string">&quot;è¾“å…¥ &#x27;exit&#x27; é€€å‡º&quot;</span>)<br>	fmt.Println()<br><br>	<span class="hljs-keyword">for</span> &#123;<br>		fmt.Print(<span class="hljs-string">&quot;ä½ : &quot;</span>)<br>		input, err := c.reader.ReadString(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> err<br>		&#125;<br><br>		input = strings.TrimSpace(input)<br>		<span class="hljs-keyword">if</span> input == <span class="hljs-string">&quot;&quot;</span> &#123;<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br><br>		<span class="hljs-keyword">if</span> strings.ToLower(input) == <span class="hljs-string">&quot;exit&quot;</span> || strings.ToLower(input) == <span class="hljs-string">&quot;quit&quot;</span> &#123;<br>			fmt.Println(<span class="hljs-string">&quot;å†è§ï¼&quot;</span>)<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>		&#125;<br><br>		fmt.Print(<span class="hljs-string">&quot;åŠ©æ‰‹: &quot;</span>)<br>		_, err = c.agent.ChatStream(context.Background(), model.Message&#123;<br>			Role:      <span class="hljs-string">&quot;user&quot;</span>,<br>			Content:   input,<br>			SessionId: c.sessionID,<br>		&#125;, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(chunk <span class="hljs-type">string</span>)</span></span> &#123;<br>			fmt.Print(chunk)<br>		&#125;)<br><br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Println(<span class="hljs-string">&quot;\né”™è¯¯:&quot;</span>, err)<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br><br>		fmt.Println()<br>		fmt.Println()<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>é‡Œé¢èƒ½çœ‹åˆ°onChunkå°±æ˜¯æŠŠæ¯æ¬¡å¾—åˆ°çš„ä¸€å°ç‰‡æ‰“å°ä¸€ä¸‹ï¼Œåœ¨æ§åˆ¶å°æœ‰æµå¼è¾“å‡ºçš„æ•ˆæœ<br>æœ€åæ˜¯mainæ–‡ä»¶</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">// å‘½ä»¤è¡Œå‚æ•°</span><br>	configPath := flag.String(<span class="hljs-string">&quot;config&quot;</span>, <span class="hljs-string">&quot;config.yaml&quot;</span>, <span class="hljs-string">&quot;é…ç½®æ–‡ä»¶è·¯å¾„&quot;</span>)<br>	simple := flag.Bool(<span class="hljs-string">&quot;simple&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;ä½¿ç”¨ç®€å•æ¨¡å¼ï¼ˆæ— é¢œè‰²ï¼‰&quot;</span>)<br>	flag.Parse()<br><br>	<span class="hljs-comment">// åŠ è½½é…ç½®</span><br>	cfg, err := config.LoadConfig(*configPath)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Printf(<span class="hljs-string">&quot;âš ï¸  åŠ è½½é…ç½®æ–‡ä»¶å¤±è´¥: %v&quot;</span>, err)<br>		log.Println(<span class="hljs-string">&quot;ä½¿ç”¨é»˜è®¤é…ç½®...&quot;</span>)<br>		cfg = config.GetDefaultConfig()<br>	&#125;<br><br>	<span class="hljs-comment">// æ£€æŸ¥ API Key</span><br>	<span class="hljs-keyword">if</span> cfg.API.Key == <span class="hljs-string">&quot;&quot;</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;âŒ é”™è¯¯: æœªè®¾ç½® API Key&quot;</span>)<br>		fmt.Println(<span class="hljs-string">&quot;è¯·åœ¨ config.yaml ä¸­è®¾ç½® api.key æˆ–è®¾ç½®ç¯å¢ƒå˜é‡ DASHSCOPE_API_KEY&quot;</span>)<br>		os.Exit(<span class="hljs-number">1</span>)<br>	&#125;<br><br>	<span class="hljs-comment">// åˆå§‹åŒ– Agent</span><br>	agent := model.InitAgent(<br>		cfg.API.URL,<br>		cfg.API.Key,<br>		cfg.API.Model,<br>		cfg.API.Prompt,<br>		cfg.Mongo.URI,<br>		cfg.Mongo.Database,<br>		cfg.Mongo.Collection,<br>		cfg.Agent.HistorySize,<br>	)<br><br>	<span class="hljs-comment">// åˆ›å»ºæ§åˆ¶å°å®ä¾‹</span><br>	consoleApp := console.NewConsole(agent, cfg.Agent.SessionID)<br><br>	<span class="hljs-comment">// å¯åŠ¨æ§åˆ¶å°å¯¹è¯</span><br>	<span class="hljs-keyword">if</span> *simple &#123;<br>		err = consoleApp.StartSimple()<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		err = consoleApp.Start()<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Fatalf(<span class="hljs-string">&quot;âŒ ç¨‹åºé”™è¯¯: %v&quot;</span>, err)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>å¾ˆæ˜æ˜¾é‡Œé¢ç”¨äº†aiç”Ÿæˆå†…å®¹ï¼Œä¸è¿‡æœ€åæ•ˆæœä¸é”™ã€‚é‡ç‚¹åœ¨äºæµå¼ä¼ è¾“çš„æ”¹é€ ã€‚</p>

  </div>

  <br />

  
  <br /><br />


  

<div id="copyright">

  <a id="license-image" rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img height="15" width="80" alt="çŸ¥è¯†å…±äº« ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…è®¸å¯åè®®" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" />
  </a>

  <p id="license-word-hyper">
    æœ¬ä½œå“é‡‡ç”¨
    <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
    çŸ¥è¯†å…±äº« ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…è®¸å¯åè®®</a>
    è¿›è¡Œè®¸å¯ã€‚
  </p>
</div>

  <div id="top">
  <div onclick="window.scrollTo({top: 0, behavior: 'smooth'})">â–²</div>
  <div onclick="document.getElementById('footer').scrollIntoView({behavior: 'smooth'})">â–¼</div>
</div>
  

</post>
  </div>

  <foot id="footer">
  <hr class="boldline" />
  <br>

  <p class="center font">
    
    <a target="_blank" rel="noopener" href="https://github.com/UndertaK33r" aria-label="GitHub">
  <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
   <path class="icon_path" d="M427.392 853.504a61.44 61.44 0 0 1-1.450667 15.530667 92.586667 92.586667 0 0 1-10.965333 27.605333c-15.061333 25.301333-40.661333 42.154667-73.642667 42.154667-77.653333 0-108.117333-38.101333-146.261333-133.504C169.216 740.693333 157.013333 725.461333 128 725.461333v-85.333333c77.653333 0 108.117333 38.101333 146.261333 133.504 25.856 64.597333 38.058667 79.786667 67.072 79.786667 0-12.373333-0.170667-23.296-0.512-38.144-0.853333-34.816-0.938667-41.941333 0.554667-51.2 0.64-20.352 5.888-34.773333 16.384-49.066667-95.232-20.736-159.445333-63.573333-196.309333-132.992l-13.824-32.426667C134.186667 510.848 128 467.072 128 416.426667c0-58.24 17.749333-110.336 50.944-153.856-10.368-41.386667-8.96-91.989333 13.909333-149.077334l7.466667-18.688 19.2-6.101333c2.56-0.853333 5.632-1.578667 9.301333-2.133333 37.290667-5.888 90.325333 8.106667 159.701334 52.48a565.930667 565.930667 0 0 1 127.274666-14.208c38.741333 0 77.226667 3.882667 114.048 11.605333 67.456-42.24 119.04-55.509333 155.306667-49.92 3.626667 0.597333 6.741333 1.322667 9.258667 2.133333l19.285333 6.101334 7.466667 18.773333c20.010667 50.218667 23.424 96.469333 16.128 136.96C875.434667 296.32 896 352.597333 896 416.512c0 53.888-3.84 94.378667-14.933333 133.802667l-11.733334 32.170666c-30.677333 69.333333-98.304 112.64-202.538666 133.248 10.837333 15.018667 15.872 30.250667 15.872 52.394667v42.666667l-0.042667 42.666666a13.013333 13.013333 0 0 0 0.341333 2.730667L682.666667 938.794667c-36.352 0-63.36-17.706667-76.672-45.653334a88.277333 88.277333 0 0 1-8.661334-40.277333v-84.736c0-3.584-0.128-3.797333-8.832-12.501333-23.296-23.296-33.834667-40.874667-33.834666-72.832v-38.613334l38.4-3.84c114.346667-11.52 176.512-43.221333 197.12-89.6l9.6-26.325333c7.68-27.562667 10.88-61.098667 10.88-107.946667 0-49.706667-17.365333-90.837333-50.218667-123.648L742.4 274.773333l7.381333-24.448c6.528-21.717333 8.106667-47.402667 1.152-76.714666a158.634667 158.634667 0 0 0-3.584 0.938666c-22.826667 6.4-51.370667 20.053333-85.76 43.008l-15.658666 10.453334-18.304-4.522667a467.754667 467.754667 0 0 0-111.829334-13.269333c-42.709333 0-84.906667 5.418667-123.946666 16.042666l-19.029334 5.205334-16.256-11.136c-35.541333-24.32-65.109333-38.826667-88.746666-45.568a158.293333 158.293333 0 0 0-4.864-1.28c-8.234667 33.92-4.992 61.781333 3.413333 82.688l9.984 25.088-18.346667 19.797333C228.693333 332.629333 213.333333 370.986667 213.333333 416.512c0 41.685333 4.864 76.202667 13.824 102.229333l11.178667 26.453334c27.904 52.352 87.168 83.84 192.853333 95.146666l38.144 4.096v38.357334c0 32-10.538667 49.536-33.834666 72.832-8.704 8.704-8.832 8.96-8.832 12.501333l-0.725334 7.893333c-0.512 2.56-0.512 9.258667 0.170667 37.205334 0.298667 12.8 0.469333 22.997333 0.554667 33.621333a33.962667 33.962667 0 0 1 0.725333 6.656z"/>
  </svg>
 </a>

    
    
    <a href="mailto:2331627921@qq.com" aria-label="Email">
  <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <path d="M513.78 602.99c-27.28 0.45-53.79-9.09-74.53-26.83l-65.96-56.64c-15.64-13.37-17.48-36.9-4.1-52.54 13.38-15.65 36.9-17.48 52.54-4.1l65.96 56.64c13.68 11.1 33.27 11.1 46.95 0L881.2 253.08l-708.02-2.61c-20.58 0-37.26-16.69-37.26-37.26s16.68-37.26 37.26-37.26H881.2c41.09-2.36 76.32 29.05 78.67 70.14a74.519 74.519 0 0 1-32.46 65.87L580.86 578.38a111.842 111.842 0 0 1-67.08 24.61z m444.57 133.4V438.28c0-20.58-16.68-37.26-37.26-37.26s-37.26 16.69-37.26 37.26V736.4c0 20.58-16.68 37.26-37.26 37.26h-521.7c-20.58 0-37.26 16.69-37.26 37.26s16.68 37.26 37.26 37.26h521.7c61.72 0.01 111.78-50.05 111.78-111.79zM362.12 363.75c0-20.58-16.68-37.26-37.26-37.26h-223.6c-20.58 0-37.26 16.69-37.26 37.26s16.68 37.26 37.26 37.26h223.59c20.58 0.01 37.27-16.68 37.27-37.26z m0 298.12c0-20.58-16.68-37.26-37.26-37.26h-111.8c-20.58 0-37.26 16.69-37.26 37.26s16.68 37.26 37.26 37.26h111.79c20.58 0 37.27-16.69 37.27-37.26z"/>
  </svg>
</a>

    
    
    
    
    
    
    
    
    
  <p>
    <br>
  <p id="hitokoto">:D è·å–ä¸­...</p>
  <script src="https://v1.hitokoto.cn/?c=a&encode=js&select=%23hitokoto" defer></script>
  <br>
  <p class="center font">
    &copy - <a href="https://UndertaK33r.github.io">UndertaK33r</a> -  2025 - Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/pcrab/hexo-theme-quark"> Quark </a> 
  </p>
  
  <br />
</foot>
  
  
  
<script src="/js/perf-toggle.js"></script>

</body>

</html>